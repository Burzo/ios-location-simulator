<script>
  // Platform configuration
  const platformConfig = {
    ios: {
      name: "iOS",
      icon: "üçé",
      color: "#007AFF",
      models: {
        "iPhone12,1": { name: "iPhone 11", image: null },
        "iPhone12,3": { name: "iPhone 11 Pro", image: null },
        "iPhone12,5": { name: "iPhone 11 Pro Max", image: null },
        "iPhone12,8": { name: "iPhone SE (2nd gen)", image: null },
        "iPhone13,1": { name: "iPhone 12 mini", image: null },
        "iPhone13,2": { name: "iPhone 12", image: null },
        "iPhone13,3": { name: "iPhone 12 Pro", image: null },
        "iPhone13,4": { name: "iPhone 12 Pro Max", image: null },
        "iPhone14,2": { name: "iPhone 13 mini", image: null },
        "iPhone14,3": { name: "iPhone 13", image: null },
        "iPhone14,4": { name: "iPhone 13 Pro", image: null },
        "iPhone14,5": { name: "iPhone 13 Pro Max", image: null },
        "iPhone14,6": { name: "iPhone SE (3rd gen)", image: null },
        "iPhone14,7": { name: "iPhone 14", image: null },
        "iPhone14,8": { name: "iPhone 14 Plus", image: null },
        "iPhone15,2": { name: "iPhone 14 Pro", image: null },
        "iPhone15,3": { name: "iPhone 14 Pro Max", image: null },
        "iPhone15,4": { name: "iPhone 15", image: null },
        "iPhone15,5": { name: "iPhone 15 Plus", image: null },
        "iPhone16,1": { name: "iPhone 15 Pro", image: null },
        "iPhone16,2": { name: "iPhone 15 Pro Max", image: null },
      },
    },
    android: {
      name: "Android",
      icon: "ü§ñ",
      color: "#34A853",
      models: {
        // Android device models are usually provided as readable names
        // from the device properties, so we don't need a complex mapping
      },
    },
  };

  // Global state
  let connectedDevice = null;

  // Utility Functions
  function setButtonLoading(button, loading = true) {
    if (loading) {
      button.disabled = true;
      if (!button.getAttribute("data-original-text")) {
        button.setAttribute("data-original-text", button.innerHTML);
      }
      button.innerHTML = '<span class="loading-text">Loading...</span>';
    } else {
      button.disabled = false;
      const originalText = button.getAttribute("data-original-text");
      if (originalText) {
        button.innerHTML = originalText;
      }
    }
  }

  function setGlobalLoading(loading = true) {
    const buttons = document.querySelectorAll(".btn");
    buttons.forEach((button) => {
      if (loading) {
        button.disabled = true;
      } else {
        button.disabled = false;
      }
    });
  }

  function setDeviceCardLoading(deviceCard, loading = true) {
    if (loading) {
      deviceCard.classList.add("connecting");
      const spinner = document.createElement("div");
      spinner.className = "loading-spinner";
      deviceCard.appendChild(spinner);
    } else {
      deviceCard.classList.remove("connecting");
      const spinner = deviceCard.querySelector(".loading-spinner");
      if (spinner) {
        spinner.remove();
      }
    }
  }

  function showStatus(message, type = "info") {
    const statusEl = document.getElementById("status");
    statusEl.classList.remove("status-hidden");
    statusEl.classList.add("status-visible");
    statusEl.innerHTML = `<p>${message}</p>`;
    statusEl.className = `status-box status-visible ${type}`;
  }

  function showDeviceStatus(message, type = "info") {
    const statusEl = document.getElementById("device-status");
    statusEl.classList.remove("status-hidden");
    statusEl.classList.add("status-visible");
    statusEl.innerHTML = `<p>${message}</p>`;
    statusEl.className = `status-box status-visible ${type}`;
  }

  function hideStatusWithAnimation(elementId) {
    const element = document.getElementById(elementId);
    element.classList.remove("status-visible");
    element.classList.add("status-hidden");
  }

  function showDeviceGridWithAnimation(elementId) {
    const element = document.getElementById(elementId);
    element.classList.remove("grid-hidden");
    element.classList.add("grid-visible");
  }

  function hideDeviceGridWithAnimation(elementId) {
    const element = document.getElementById(elementId);
    element.classList.remove("grid-visible");
    element.classList.add("grid-hidden");
  }

  function showConnectedDeviceWithAnimation(elementId) {
    const element = document.getElementById(elementId);
    element.classList.remove("display-hidden");
    element.classList.add("display-visible");
  }

  function hideConnectedDeviceWithAnimation(elementId) {
    const element = document.getElementById(elementId);
    element.classList.remove("display-visible");
    element.classList.add("display-hidden");
  }

  // Platform-specific functions
  function getPlatformConfig(platform) {
    return platformConfig[platform] || platformConfig.android;
  }

  function getDeviceDisplayName(device) {
    if (device.platform === "ios") {
      // For iOS, use the device name if available, otherwise try to parse model
      return device.name || "iOS Device";
    } else if (device.platform === "android") {
      // For Android, the name usually comes from the device property
      return device.name || "Android Device";
    }
    return device.name || "Unknown Device";
  }

  function createDeviceCard(device) {
    const platform = getPlatformConfig(device.platform);
    const isUSB = device.connection_type === "usb";
    const displayName = getDeviceDisplayName(device);

    return `
      <div class="device-card" data-device-id="${device.id}" data-platform="${
      device.platform
    }" onclick="connectToDevice(event, '${device.id}', '${device.platform}')">
        <div class="platform-badge" style="background-color: ${
          platform.color
        }20; color: ${platform.color};">
          <span class="platform-icon">${platform.icon}</span>
          <span class="platform-name">${platform.name}</span>
        </div>
        <div class="device-card-header">
          <div class="device-image">
          </div>
          <div class="device-info">
            <div class="device-name">${displayName}</div>
            <div class="device-model">${
              device.platform === "ios" ? "iPhone" : "Android Device"
            }</div>
            <div class="device-status">Ready to connect</div>
          </div>
        </div>
        <div class="device-details">
          <div class="device-detail">
            <div class="device-detail-label">Platform</div>
            <div class="device-detail-value">${platform.name}</div>
          </div>
          <div class="device-detail">
            <div class="device-detail-label">Connection</div>
            <div class="device-detail-value">${device.connection_type.toUpperCase()}</div>
          </div>
        </div>
      </div>
    `;
  }

  async function refreshDevices(event) {
    const button = event.target;
    setButtonLoading(button, true);

    // Show device status element in case it was hidden
    const deviceStatus = document.getElementById("device-status");
    if (deviceStatus) deviceStatus.style.display = "block";

    hideDeviceGridWithAnimation("device-list");
    const deviceList = document.getElementById("device-list");
    deviceList.innerHTML = "";

    try {
      const response = await fetch("/api/devices");
      const result = await response.json();

      if (result.success && result.devices) {
        if (result.devices.length > 0) {
          hideStatusWithAnimation("device-status");

          // Create device cards for all platforms
          deviceList.innerHTML = result.devices
            .map((device) => createDeviceCard(device))
            .join("");
          showDeviceGridWithAnimation("device-list");

          // Show platform summary
          const iosCount = result.devices.filter(
            (d) => d.platform === "ios"
          ).length;
          const androidCount = result.devices.filter(
            (d) => d.platform === "android"
          ).length;
          let summary = `Found ${result.devices.length} device(s): `;
          if (iosCount > 0) summary += `${iosCount} iOS`;
          if (iosCount > 0 && androidCount > 0) summary += ", ";
          if (androidCount > 0) summary += `${androidCount} Android`;

          console.log(summary);
        } else {
          showDeviceStatus(
            "No devices found. Ensure:<br>" +
              "‚Ä¢ <strong>iOS:</strong> Device connected via USB, trusted, and unlocked<br>" +
              "‚Ä¢ <strong>Android:</strong> USB debugging enabled and device authorized",
            "error"
          );
        }
      } else {
        showDeviceStatus(
          `Device scan failed: ${result.error || "Unknown error"}`,
          "error"
        );
        hideDeviceGridWithAnimation("device-list");
      }
    } catch (error) {
      showDeviceStatus(`Connection error: ${error.message}`, "error");
      hideDeviceGridWithAnimation("device-list");
    } finally {
      setButtonLoading(button, false);
    }
  }

  async function connectToDevice(event, deviceId, platform) {
    event.stopPropagation();
    const deviceCard = event.currentTarget;
    setDeviceCardLoading(deviceCard, true);
    setGlobalLoading(true);

    const platformConfig = getPlatformConfig(platform);

    try {
      const response = await fetch("/api/connect", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          deviceId: deviceId,
          platform: platform,
        }),
      });

      const result = await response.json();

      if (result.success) {
        connectedDevice = {
          id: deviceId,
          platform: platform,
          name: deviceCard.querySelector(".device-name").textContent,
          model: deviceCard.querySelector(".device-model").textContent,
        };

        displayConnectedDevice(result);
        hideDeviceGridWithAnimation("device-list");

        // Hide device setup elements when connected
        const setupDescription = document.getElementById(
          "device-setup-description"
        );
        const scanControls = document.getElementById("device-scan-controls");
        const deviceStatus = document.getElementById("device-status");

        if (setupDescription) setupDescription.style.display = "none";
        if (scanControls) scanControls.style.display = "none";
        if (deviceStatus) deviceStatus.style.display = "none";

        // Enable location simulation
        document.getElementById("location-simulation").style.display = "block";
      } else {
        showDeviceStatus(`Connection failed: ${result.message}`, "error");
      }
    } catch (error) {
      showDeviceStatus(`Connection error: ${error.message}`, "error");
    } finally {
      setDeviceCardLoading(deviceCard, false);
      setGlobalLoading(false);
    }
  }

  function displayConnectedDevice(connectionResult) {
    const details = connectionResult.details || {};
    const platform = getPlatformConfig(
      details.platform || connectedDevice.platform
    );

    // Update connected device display
    document.getElementById("connected-device-name").textContent =
      connectedDevice.name;
    document.getElementById("connected-device-model").textContent =
      connectedDevice.model;
    document.getElementById("connected-device-platform").textContent =
      platform.name;
    document.getElementById("connected-device-id").textContent =
      connectedDevice.id;
    document.getElementById("connected-connection-type").textContent = "USB";

    // Update platform icon
    const platformIcon = document.getElementById("connected-platform-icon");
    platformIcon.textContent = platform.icon;
    platformIcon.style.color = platform.color;
    platformIcon.style.fontSize = "48px";

    // Update version information based on platform
    const versionLabel = document.getElementById("connected-version-label");
    const versionValue = document.getElementById("connected-version-value");
    const extraDetails = document.getElementById("connected-extra-details");
    const extraLabel = document.getElementById("connected-extra-label");
    const extraValue = document.getElementById("connected-extra-value");

    if (details.platform === "ios") {
      versionLabel.textContent = "iOS Version";
      versionValue.textContent = details.ios_version || "Unknown";
      if (details.build_version) {
        extraDetails.style.display = "block";
        extraLabel.textContent = "Build";
        extraValue.textContent = details.build_version;
      }
    } else if (details.platform === "android") {
      versionLabel.textContent = "Android Version";
      versionValue.textContent = details.android_version || "Unknown";
      if (details.model) {
        extraDetails.style.display = "block";
        extraLabel.textContent = "Model";
        extraValue.textContent = details.model;
      }
    }

    showConnectedDeviceWithAnimation("connected-device");
  }

  async function disconnectDevice(event) {
    const button = event.target;
    setButtonLoading(button, true);

    try {
      const response = await fetch("/api/disconnect", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      const result = await response.json();

      if (result.success) {
        connectedDevice = null;
        hideConnectedDeviceWithAnimation("connected-device");

        // Show device setup elements again when disconnected
        const setupDescription = document.getElementById(
          "device-setup-description"
        );
        const scanControls = document.getElementById("device-scan-controls");

        if (setupDescription) setupDescription.style.display = "block";
        if (scanControls) scanControls.style.display = "block";

        // Hide location simulation
        document.getElementById("location-simulation").style.display = "none";

        // Show device list again
        refreshDevices({
          target: document.querySelector("#device-scan-controls button"),
        });
      } else {
        showDeviceStatus(`Disconnect failed: ${result.message}`, "error");
      }
    } catch (error) {
      showDeviceStatus(`Disconnect error: ${error.message}`, "error");
    } finally {
      setButtonLoading(button, false);
    }
  }

  async function setLocationOnDevice(lat, lng) {
    if (!connectedDevice) {
      showStatus(
        "No device connected. Please connect a device first.",
        "error"
      );
      return;
    }

    const platform = getPlatformConfig(connectedDevice.platform);
    showStatus(`Setting location on ${platform.name} device...`, "info");

    try {
      const response = await fetch("/api/location/set", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          latitude: lat,
          longitude: lng,
          deviceId: connectedDevice.id,
          platform: connectedDevice.platform,
        }),
      });

      const result = await response.json();

      if (result.success) {
        showStatus(
          `Location set successfully on ${platform.name} device: ${lat}, ${lng}` +
            (result.method ? ` (via ${result.method})` : ""),
          "success"
        );
      } else {
        showStatus(`Failed to set location: ${result.message}`, "error");
      }
    } catch (error) {
      showStatus(`Location set error: ${error.message}`, "error");
    }
  }

  async function clearLocationOnDevice() {
    if (!connectedDevice) {
      showStatus(
        "No device connected. Please connect a device first.",
        "error"
      );
      return;
    }

    const platform = getPlatformConfig(connectedDevice.platform);
    showStatus(`Clearing location on ${platform.name} device...`, "info");

    try {
      const response = await fetch("/api/location/clear", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          deviceId: connectedDevice.id,
          platform: connectedDevice.platform,
        }),
      });

      const result = await response.json();

      if (result.success) {
        showStatus(
          `Location cleared successfully on ${platform.name} device`,
          "success"
        );
      } else {
        showStatus(`Failed to clear location: ${result.message}`, "error");
      }
    } catch (error) {
      showStatus(`Location clear error: ${error.message}`, "error");
    }
  }

  // Quick location functions
  async function setQuickLocation(name, lat, lng, event) {
    // Find the specific quick location button that was clicked
    const clickedBtn = event ? event.target : null;
    if (clickedBtn) {
      setButtonLoading(clickedBtn, true);
    }

    try {
      await setLocationOnDevice(lat, lng);
    } finally {
      if (clickedBtn) {
        setButtonLoading(clickedBtn, false);
      }
    }
  }

  async function setCustomLocation() {
    const lat = document.getElementById("latitude").value;
    const lng = document.getElementById("longitude").value;

    if (!lat || !lng) {
      showStatus("Please enter both latitude and longitude", "error");
      return;
    }

    // Find and set loading on Set Location button
    const setLocationBtn = document.querySelector(
      'button[onclick="setCustomLocation()"]'
    );
    if (setLocationBtn) {
      setButtonLoading(setLocationBtn, true);
    }

    try {
      await setLocationOnDevice(parseFloat(lat), parseFloat(lng));
    } finally {
      if (setLocationBtn) {
        setButtonLoading(setLocationBtn, false);
      }
    }
  }

  async function clearLocation() {
    // Find and set loading on Clear Location button
    const clearLocationBtn = document.querySelector(
      'button[onclick="clearLocation()"]'
    );
    if (clearLocationBtn) {
      setButtonLoading(clearLocationBtn, true);
    }

    try {
      await clearLocationOnDevice();
    } finally {
      if (clearLocationBtn) {
        setButtonLoading(clearLocationBtn, false);
      }
    }
  }

  // Initialize page
  document.addEventListener("DOMContentLoaded", function () {
    // Hide location simulation initially
    const locationSimulation = document.getElementById("location-simulation");
    if (locationSimulation) {
      locationSimulation.style.display = "none";
    }

    // Store original button text for all buttons (including hidden ones)
    const storeButtonText = () => {
      const buttons = document.querySelectorAll(".btn");
      buttons.forEach((button) => {
        if (!button.getAttribute("data-original-text")) {
          button.setAttribute("data-original-text", button.innerHTML);
        }
      });
    };

    // Store text for initially visible buttons
    storeButtonText();

    // Also store text when location simulation becomes visible
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "style"
        ) {
          const target = mutation.target;
          if (
            target.id === "location-simulation" &&
            target.style.display === "block"
          ) {
            setTimeout(storeButtonText, 100);
          }
        }
      });
    });

    if (locationSimulation) {
      observer.observe(locationSimulation, { attributes: true });
    }

    // Automatically scan for devices on page load
    const checkDevicesButton = document.querySelector(
      "#device-scan-controls button"
    );
    if (checkDevicesButton) {
      refreshDevices({ target: checkDevicesButton });
    }
  });
</script>
